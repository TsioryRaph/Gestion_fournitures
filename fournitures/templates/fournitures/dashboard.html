{% extends 'fournitures/base.html' %}

{% block title %}Tableau de bord - Gestion des Fournitures{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Cartes de statistiques -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-boxes"></i>
            </div>
            <div class="stat-info">
                <h3>{{ total_fournitures }}</h3>
                <p>Fournitures totales</p>
            </div>
        </div>

        <div class="stat-card stat-alert">
            <div class="stat-icon">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <div class="stat-info">
                <h3>{{ fournitures_alerte }}</h3>
                <p>En alerte de stock<br><small class="stat-subtext">(sans commande en cours)</small></p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <div class="stat-info">
                <h3>{{ commandes_attente }}</h3>
                <p>Commandes en attente</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-info">
                <h3>{{ commandes_retard }}</h3>
                <p>Commandes en retard</p>
            </div>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="section">
        <h2><i class="fas fa-bolt"></i> Actions rapides</h2>
        <div class="actions-grid">
            <a href="{% url 'mouvement' %}?type=ENTREE" class="action-btn">
                <i class="fas fa-plus-circle"></i>
                <span>Nouvelle entrée</span>
            </a>
            <a href="{% url 'mouvement' %}?type=SORTIE" class="action-btn">
                <i class="fas fa-minus-circle"></i>
                <span>Nouvelle sortie</span>
            </a>
            <a href="{% url 'ajouter_fourniture' %}" class="action-btn">
                <i class="fas fa-box"></i>
                <span>Ajouter produit</span>
            </a>
            <a href="{% url 'commande' %}" class="action-btn">
                <i class="fas fa-file-invoice"></i>
                <span>Nouvelle commande</span>
            </a>
        </div>
    </div>

    <!-- Section graphiques -->
    <div class="section">
        <h2><i class="fas fa-chart-bar"></i> Statistiques visuelles</h2>
        <div class="charts-grid">
            <div class="chart-container">
                <div class="chart-card">
                    <h5><i class="fas fa-chart-pie"></i> Répartition par type</h5>
                    <div id="chart-type" class="chart"></div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-card">
                    <h5><i class="fas fa-exchange-alt"></i> Mouvements (7 jours)</h5>
                    <div id="chart-mouvements" class="chart"></div>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-card">
                    <h5><i class="fas fa-star"></i> Top 5 produits</h5>
                    <div id="chart-top-produits" class="chart"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fournitures en alerte -->
    <div class="section">
        <h2><i class="fas fa-exclamation-triangle"></i> Fournitures en alerte critique</h2>
        <p class="section-subtitle">Produits en alerte qui n'ont pas encore de commande en cours</p>

        {% if produits_alerte %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Référence</th>
                        <th>Désignation</th>
                        <th>Type</th>
                        <th>Stock</th>
                        <th>Seuil</th>
                        <th>Stock max</th>
                        <th>À commander</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for produit in produits_alerte %}
                    <tr class="table-warning">
                        <td><strong>{{ produit.reference }}</strong></td>
                        <td>{{ produit.designation }}</td>
                        <td><span class="badge badge-type">{{ produit.type.nom }}</span></td>
                        <td>
                            <span class="badge badge-stock">
                                {{ produit.stock }} {{ produit.unite }}
                            </span>
                            <div class="progress mt-1">
                                <div class="progress-bar {% if produit.pourcentage_stock < 20 %}bg-danger{% elif produit.pourcentage_stock < 50 %}bg-warning{% else %}bg-success{% endif %}"
                                     style="width: {{ produit.pourcentage_stock }}%"
                                     role="progressbar"
                                     aria-valuenow="{{ produit.pourcentage_stock }}"
                                     aria-valuemin="0"
                                     aria-valuemax="100">
                                </div>
                            </div>
                        </td>
                        <td>{{ produit.seuil_alerte }}</td>
                        <td>{{ produit.stock_max }}</td>
                        <td>
                            {% if produit.quantite_a_commander > 0 %}
                            <span class="badge badge-commande">
                                {{ produit.quantite_a_commander }} {{ produit.unite }}
                            </span>
                            {% else %}
                            <span class="badge badge-secondary">R.A.S</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group">
                                <a href="{% url 'commande' %}?produit={{ produit.id }}" class="btn btn-sm btn-danger" title="Créer une commande">
                                    <i class="fas fa-shopping-cart"></i>
                                </a>
                                <a href="{% url 'detail_fourniture' produit.id %}" class="btn btn-sm btn-info" title="Détails">
                                    <i class="fas fa-eye"></i>
                                </a>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="text-center mt-3">
            <a href="{% url 'commande' %}" class="btn btn-warning">
                <i class="fas fa-lightbulb"></i> Voir toutes les suggestions
            </a>
        </div>
        {% else %}
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> Excellent ! Aucune fourniture en alerte critique.
        </div>
        {% endif %}
    </div>

    <!-- Derniers mouvements et commandes -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="section">
                <h2><i class="fas fa-history"></i> Derniers mouvements</h2>
                {% if mouvements_recents %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Produit</th>
                                <th>Type</th>
                                <th>Qté</th>
                                <th>Par</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mouvement in mouvements_recents %}
                            <tr>
                                <td><small class="text-muted">{{ mouvement.date|date:"d/m H:i" }}</small></td>
                                <td>{{ mouvement.produit.designation|truncatechars:25 }}</td>
                                <td>
                                    {% if mouvement.type_mouvement == 'ENTREE' %}
                                    <span class="badge badge-success">Entrée</span>
                                    {% else %}
                                    <span class="badge badge-danger">Sortie</span>
                                    {% endif %}
                                </td>
                                <td>{{ mouvement.quantite }} {{ mouvement.produit.unite }}</td>
                                <td><small>{{ mouvement.utilisateur.username|default:"-" }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-right">
                    <!-- CORRIGÉ : Retirer le lien ou le remplacer par une vue existante -->
                    <a href="{% url 'mouvement' %}" class="btn btn-sm btn-outline-primary">Gérer les mouvements</a>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Aucun mouvement récent.
                </div>
                {% endif %}
            </div>
        </div>

        <div class="col-lg-6 mb-4">
            <div class="section">
                <h2><i class="fas fa-clipboard-list"></i> Commandes récentes</h2>
                {% if commandes_recentes %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Produit</th>
                                <th>Qté</th>
                                <th>Statut</th>
                                <th>Fournisseur</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for commande in commandes_recentes %}
                            <tr>
                                <td><small class="text-muted">{{ commande.date_creation|date:"d/m" }}</small></td>
                                <td>{{ commande.produit.designation|truncatechars:25 }}</td>
                                <td>{{ commande.quantite }} {{ commande.produit.unite }}</td>
                                <td>
                                    {% if commande.status == 'EN_ATTENTE' %}
                                    <span class="badge badge-warning">En attente</span>
                                    {% elif commande.status == 'VALIDEE' %}
                                    <span class="badge badge-primary">Validée</span>
                                    {% elif commande.status == 'RECUE' %}
                                    <span class="badge badge-success">Reçue</span>
                                    {% elif commande.status == 'ANNULEE' %}
                                    <span class="badge badge-danger">Annulée</span>
                                    {% elif commande.status == 'EN_COURS' %}
                                    <span class="badge badge-info">En cours</span>
                                    {% endif %}
                                </td>
                                <td><small>{{ commande.fournisseur.nom|default:"-"|truncatechars:15 }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="text-right">
                    <!-- CORRIGÉ : Retirer ou remplacer par une vue existante -->
                    <a href="{% url 'commande' %}" class="btn btn-sm btn-outline-primary">Gérer les commandes</a>
                </div>
                {% else %}
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Aucune commande récente.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Styles CSS améliorés -->
<style>
:root {
    --primary: #007bff;
    --secondary: #6c757d;
    --success: #28a745;
    --danger: #dc3545;
    --warning: #ffc107;
    --info: #17a2b8;
    --light: #f8f9fa;
    --dark: #343a40;
}

.dashboard {
    padding: 20px;
}

/* Cartes de statistiques */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    display: flex;
    align-items: center;
    gap: 15px;
    transition: transform 0.3s, box-shadow 0.3s;
    border-left: 4px solid var(--primary);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
}

.stat-alert {
    border-left-color: var(--danger);
    background: linear-gradient(135deg, #fff5f5 0%, #fff 100%);
}

.stat-alert .stat-icon {
    color: var(--danger);
}

.stat-icon {
    font-size: 2.2rem;
    color: var(--primary);
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 123, 255, 0.1);
    border-radius: 10px;
}

.stat-info h3 {
    margin: 0;
    font-size: 1.8rem;
    font-weight: 700;
    color: var(--dark);
}

.stat-info p {
    margin: 5px 0 0 0;
    color: var(--secondary);
    font-size: 0.9rem;
}

.stat-subtext {
    font-size: 0.8rem;
    opacity: 0.8;
}

/* Sections */
.section {
    background: white;
    border-radius: 12px;
    padding: 25px;
    margin-bottom: 30px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
}

.section h2 {
    margin-bottom: 15px;
    color: var(--dark);
    font-size: 1.5rem;
    border-bottom: 2px solid var(--light);
    padding-bottom: 10px;
}

.section-subtitle {
    color: var(--secondary);
    margin-bottom: 20px;
    font-size: 0.95rem;
}

/* Actions rapides */
.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 15px;
}

.action-btn {
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 10px;
    padding: 20px 15px;
    text-align: center;
    color: var(--dark);
    text-decoration: none;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 12px;
    transition: all 0.3s;
}

.action-btn:hover {
    background: var(--light);
    border-color: var(--primary);
    color: var(--primary);
    text-decoration: none;
    transform: translateY(-3px);
}

.action-btn i {
    font-size: 2rem;
}

/* Graphiques */
.charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
}

.chart-container {
    height: 100%;
}

.chart-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    height: 100%;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.chart-card h5 {
    margin-bottom: 20px;
    color: var(--dark);
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

.chart {
    width: 100%;
    min-height: 280px;
}

/* Tableaux */
.table-responsive {
    border-radius: 8px;
    overflow: hidden;
}

.table {
    margin-bottom: 0;
}

.table th {
    background-color: var(--light);
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: var(--dark);
}

.table-warning {
    background-color: #fff3cd !important;
}

.table-warning:hover {
    background-color: #ffeaa7 !important;
}

/* Badges */
.badge {
    padding: 6px 12px;
    font-weight: 500;
}

.badge-type {
    background-color: #e9ecef;
    color: var(--dark);
}

.badge-stock {
    background-color: var(--danger);
    color: white;
}

.badge-commande {
    background-color: var(--primary);
    color: white;
}

/* Progress bars */
.progress {
    height: 8px;
    background-color: #e9ecef;
    border-radius: 4px;
    overflow: hidden;
}

.progress-bar {
    border-radius: 4px;
}

/* Boutons */
.btn-group {
    display: flex;
    gap: 5px;
}

.btn-sm {
    padding: 5px 10px;
    font-size: 0.875rem;
}

/* Responsive */
@media (max-width: 768px) {
    .dashboard {
        padding: 10px;
    }

    .stats-grid {
        grid-template-columns: 1fr;
    }

    .charts-grid {
        grid-template-columns: 1fr;
    }

    .section {
        padding: 15px;
    }

    .action-btn {
        padding: 15px 10px;
    }
}

@media (max-width: 576px) {
    .actions-grid {
        grid-template-columns: 1fr 1fr;
    }

    .stat-card {
        padding: 15px;
    }

    .stat-icon {
        width: 50px;
        height: 50px;
        font-size: 1.8rem;
    }
}
</style>

<!-- Scripts pour les graphiques -->
<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
<script>
$(document).ready(function() {
    // Vérifier que les données sont disponibles
    {% if series_type_json %}
    // Graphique 1 : Camembert
    var chartType = new ApexCharts(document.querySelector("#chart-type"), {
        series: {{ series_type_json|safe }},
        chart: {
            type: 'pie',
            height: 280,
            foreColor: '#373d3f'
        },
        labels: {{ labels_type_json|safe }},
        colors: ['#007bff', '#28a745', '#ffc107', '#dc3545', '#6f42c1', '#17a2b8', '#20c997', '#fd7e14'],
        legend: {
            position: 'bottom',
            fontSize: '14px'
        },
        tooltip: {
            y: {
                formatter: function(val) {
                    return val + " produit" + (val > 1 ? "s" : "");
                }
            }
        },
        responsive: [{
            breakpoint: 480,
            options: {
                chart: {
                    width: '100%'
                },
                legend: {
                    position: 'bottom'
                }
            }
        }]
    });
    chartType.render();
    {% endif %}

    {% if entree_data_json and sortie_data_json %}
    // Graphique 2 : Barres des mouvements
    var chartMouvements = new ApexCharts(document.querySelector("#chart-mouvements"), {
        series: [{
            name: 'Entrées',
            data: {{ entree_data_json|safe }}
        }, {
            name: 'Sorties',
            data: {{ sortie_data_json|safe }}
        }],
        chart: {
            type: 'bar',
            height: 280,
            stacked: false,
            foreColor: '#373d3f'
        },
        plotOptions: {
            bar: {
                horizontal: false,
                columnWidth: '70%',
                borderRadius: 4
            },
        },
        dataLabels: {
            enabled: false
        },
        stroke: {
            show: true,
            width: 1,
            colors: ['transparent']
        },
        xaxis: {
            categories: {{ dates_mouvements_json|safe }},
        },
        yaxis: {
            title: {
                text: 'Quantité'
            }
        },
        colors: ['#28a745', '#dc3545'],
        fill: {
            opacity: 0.9
        },
        tooltip: {
            y: {
                formatter: function(val) {
                    return val + " unités";
                }
            }
        }
    });
    chartMouvements.render();
    {% endif %}

    {% if top_series_json %}
    // Graphique 3 : Top produits
    var chartTop = new ApexCharts(document.querySelector("#chart-top-produits"), {
        series: [{
            data: {{ top_series_json|safe }}
        }],
        chart: {
            type: 'bar',
            height: 280,
            foreColor: '#373d3f'
        },
        plotOptions: {
            bar: {
                horizontal: true,
                borderRadius: 4,
                barHeight: '70%'
            }
        },
        dataLabels: {
            enabled: true,
            formatter: function(val) {
                return val + " unités";
            },
            style: {
                fontSize: '12px',
                colors: ['#fff']
            }
        },
        xaxis: {
            categories: {{ top_labels_json|safe }},
        },
        colors: ['#007bff'],
        tooltip: {
            y: {
                formatter: function(val) {
                    return val + " unités sorties";
                }
            }
        }
    });
    chartTop.render();
    {% endif %}
});
</script>
{% endblock %}